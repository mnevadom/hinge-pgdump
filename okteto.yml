build:
  restore-job:
    context: job-restore
    dockerfile: Dockerfile

deploy:
  - name: Clean Previous PostgreSQL Deployment
    command: |
      echo "Cleaning up any previous PostgreSQL deployment..."
      okteto destroy -v || echo "No previous deployment found"
      echo "✓ Cleanup completed"

  - name: Deploy PostgreSQL Compose
    command: |
      echo "Deploying PostgreSQL via docker-compose..."
      okteto deploy --file postgres-infra/docker-compose.yml --wait
      echo "✓ PostgreSQL deployed successfully"

  - name: Copy Dump to PostgreSQL Pod
    command: |
      echo "Waiting for PostgreSQL pod to be ready..."

      # Wait for PostgreSQL pod to exist
      RETRY=0
      MAX_RETRIES=30
      while [ $RETRY -lt $MAX_RETRIES ]; do
        POD_COUNT=$(kubectl get pods -n ${OKTETO_NAMESPACE} -l stack.okteto.com/service=main-dev-db --no-headers 2>/dev/null | wc -l)
        if [ "$POD_COUNT" -gt 0 ]; then
          echo "✓ PostgreSQL pod found"
          break
        fi
        echo "Waiting for pod... ($RETRY/$MAX_RETRIES)"
        sleep 5
        RETRY=$((RETRY + 1))
      done

      if [ $RETRY -eq $MAX_RETRIES ]; then
        echo "✗ PostgreSQL pod not found after waiting"
        echo "Deployment may have failed. Check:"
        echo "  kubectl get pods -n ${OKTETO_NAMESPACE}"
        exit 1
      fi

      echo ""
      echo "Running copy script..."

      # Export LOCAL_DUMP_FILE if not set (default to pg_dump.sql)
      export LOCAL_DUMP_FILE="${LOCAL_DUMP_FILE:-pg_dump.sql}"

      ./1-copy-dump.sh

      echo ""
      echo "Waiting a few seconds for file to sync across mounts..."
      sleep 10
      echo "✓ Ready to start restore job"

      # Create marker file to indicate copy succeeded
      touch /tmp/copy-succeeded

  - name: Restore Database
    command: |
      # Check if copy step succeeded
      if [ ! -f /tmp/copy-succeeded ]; then
        echo "⚠️  Copy step did not complete successfully"
        echo "⚠️  Skipping restore step"
        exit 0
      fi

      echo "Starting database restore job..."

      # Create ConfigMap and Job with environment variable substitution
      envsubst < job-restore/restore-job.yaml | kubectl apply -n ${OKTETO_NAMESPACE} -f -

      echo "✓ Restore job created and running in background"
      echo ""
      echo "Monitor restore progress with:"
      echo "  kubectl logs -f -n ${OKTETO_NAMESPACE} job/postgres-restore-job"
      echo ""
      echo "Check job status:"
      echo "  kubectl get job -n ${OKTETO_NAMESPACE} postgres-restore-job"
