build:
  restore-job:
    context: job-restore
    dockerfile: Dockerfile

deploy:
  - name: Clean Previous PostgreSQL Deployment
    command: |
      echo "Cleaning up any previous PostgreSQL deployment..."
      okteto destroy -v || echo "No previous deployment found"
      echo "✓ Cleanup completed"

  - name: Deploy PostgreSQL Compose
    command: |
      echo "Deploying PostgreSQL via docker-compose..."
      okteto deploy --file postgres-infra/docker-compose.yml --wait
      echo "✓ PostgreSQL deployed successfully"

  - name: Copy Dump to PostgreSQL Pod
    command: |
      echo "Checking if pg_dump.sql exists..."
      if [ ! -f "pg_dump.sql" ]; then
        echo "⚠️  Warning: pg_dump.sql not found in project root"
        echo "⚠️  Skipping dump copy and restore steps"
        echo "⚠️  To restore a dump later, place pg_dump.sql in project root and run:"
        echo "    ./1-copy-dump.sh && ./2-restore-dump.sh"
        exit 0
      fi

      echo "Running copy script..."
      ./1-copy-dump.sh

  - name: Restore Database
    command: |
      echo "Starting database restore job..."
      echo ""

      # Load environment variables
      if [ -f "postgres-infra/.env" ]; then
        export $(cat postgres-infra/.env | grep -v '^#' | xargs)
      fi

      # Create ConfigMap with database name
      envsubst < job-restore/restore-job.yaml | kubectl apply -n ${OKTETO_NAMESPACE} -f -

      echo "✓ Restore job created"
      echo ""
      echo "Waiting for restore job to complete (this may take several hours)..."
      echo "You can monitor progress with:"
      echo "  kubectl logs -f -n ${OKTETO_NAMESPACE} job/postgres-restore-job"
      echo ""

      # Wait for job to complete (with timeout)
      kubectl wait --for=condition=complete --timeout=18000s -n ${OKTETO_NAMESPACE} job/postgres-restore-job || {
        echo ""
        echo "⚠️  Job did not complete within timeout or failed"
        echo "Check job status:"
        echo "  kubectl get job -n ${OKTETO_NAMESPACE} postgres-restore-job"
        echo "Check logs:"
        echo "  kubectl logs -n ${OKTETO_NAMESPACE} job/postgres-restore-job"
        exit 1
      }

      echo ""
      echo "✓ Database restore completed successfully!"
      echo ""
      echo "View restore logs:"
      echo "  kubectl logs -n ${OKTETO_NAMESPACE} job/postgres-restore-job"
