build:
  restore-job:
    context: job-restore
    dockerfile: Dockerfile

deploy:
  - name: Deploy PostgreSQL
    command: |
      echo "Deploying PostgreSQL..."
      okteto deploy --file postgres-infra/docker-compose.yml --wait
      echo "✓ PostgreSQL deployed"

  - name: Copy Dump to PostgreSQL Pod
    command: |
      echo "Running copy script..."
      export LOCAL_DUMP_FILE="${LOCAL_DUMP_FILE:-pg_dump.sql}"
      ./1-copy-dump.sh || exit 0

  - name: Restore Database
    command: |
      echo "Starting restore job..."

      # Get the dump filename (basename of LOCAL_DUMP_FILE)
      export LOCAL_DUMP_FILE="${LOCAL_DUMP_FILE:-pg_dump.sql}"
      export DUMP_FILENAME=$(basename "$LOCAL_DUMP_FILE")

      envsubst < job-restore/restore-job.yaml | kubectl apply -n ${OKTETO_NAMESPACE} -f -
      echo "✓ Restore job created"
      echo ""
      echo "Monitor progress:"
      echo "  kubectl logs -f -n ${OKTETO_NAMESPACE} job/postgres-restore-job"
