build:
  restore-job:
    context: job-restore
    dockerfile: Dockerfile

deploy:
  - name: Load Environment Variables
    command: |
      echo "Loading environment variables..."

      # Load variables from Okteto admin panel if available
      if [ -f "$OKTETO_ENV" ]; then
        echo "Loading variables from Okteto admin panel..."
        set -a
        source "$OKTETO_ENV"
        set +a
      fi

      # Load local .env file
      if [ -f "postgres-infra/.env" ]; then
        echo "Loading variables from postgres-infra/.env..."
        set -a
        source "postgres-infra/.env"
        set +a
      fi

      echo "✓ Environment variables loaded"

  - name: Clean Previous PostgreSQL Deployment
    command: |
      echo "Cleaning up any previous PostgreSQL deployment..."
      okteto destroy -v || echo "No previous deployment found"
      echo "✓ Cleanup completed"

  - name: Deploy PostgreSQL Compose
    command: |
      echo "Deploying PostgreSQL via docker-compose..."
      okteto deploy --file postgres-infra/docker-compose.yml --wait
      echo "✓ PostgreSQL deployed successfully"

  - name: Copy Dump to PostgreSQL Pod
    command: |
      echo "Running copy script..."
      echo "Note: If pg_dump.sql doesn't exist, the script will show an error"
      ./1-copy-dump.sh || {
        echo ""
        echo "⚠️  Copy script failed or pg_dump.sql not found"
        echo "⚠️  Skipping restore step"
        echo "⚠️  To restore later, place pg_dump.sql in project root and run:"
        echo "    ./1-copy-dump.sh"
        exit 0
      }

      echo ""
      echo "Waiting a few seconds for file to sync across mounts..."
      sleep 10
      echo "✓ Ready to start restore job"

  - name: Restore Database
    command: |
      echo "Starting database restore job..."
      echo ""

      # Load environment variables from Okteto admin panel
      if [ -f "$OKTETO_ENV" ]; then
        set -a
        source "$OKTETO_ENV"
        set +a
      fi

      # Load environment variables from local .env
      if [ -f "postgres-infra/.env" ]; then
        set -a
        source "postgres-infra/.env"
        set +a
      fi

      # Create ConfigMap and Job (envsubst will replace variables)
      envsubst < job-restore/restore-job.yaml | kubectl apply -n ${OKTETO_NAMESPACE} -f -

      echo "✓ Restore job created and running in background"
      echo ""
      echo "Monitor restore progress with:"
      echo "  kubectl logs -f -n ${OKTETO_NAMESPACE} job/postgres-restore-job"
      echo ""
      echo "Check job status:"
      echo "  kubectl get job -n ${OKTETO_NAMESPACE} postgres-restore-job"
